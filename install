#!/bin/bash
###############################################
# install                          4 May 2018 #
#                                   Ed Rogers #
#                                             #
#    This script, called by the EC2 DSW       #
# at instance first launch, sets up the dev   #
# environment. It is run as user, and will:   #
# * Fix a known ubuntu issue with /etc/hosts  #
# * Copy over some dotfiles from this repo    #
# * Install Python 3.6.5                      #
# * Install Emacs25                           #
# * Install shell integration for iterm2      #
# * Install virtualenv                        #
# * Install matplotlib                        #
# * Install tmux                              #
# * Install curl, htop, unzip, & mysqlclient  #
# * Change the default shell to zsh           #
# * Install the oh-my-zsh theme               #
# * Clean up                                  #
#                                             #
###############################################

set -x

env

echo $PATH

which python
whereis python

which python3
whereis python3

# Install iterm2 tweaks
curl -L https://iterm2.com/shell_integration/bash -o ~/.iterm2_shell_integration.bash
echo "source ~/.iterm2_shell_integration.bash" >> ~/.bashrc

# Jupyter NB Extensions
python3 -m pip install -U pip
python3 -m pip install --upgrade jupyter_contrib_nbextensions
python3 -m pip install --upgrade jupyter_nbextensions_configurator
python3 -m pip install -U autopep8 nbdime
python3 -m pip install -U jupyterlab black jupyterlab-git jupyterlab_latex

jupyter contrib nbextension install --sys-prefix
jupyter nbextensions_configurator enable --sys-prefix
jupyter nbextension enable toc2/main --user
jupyter nbextension enable code_prettify/autopep8 --user
#nbdime extensions --enable --user
nbdime extensions --enable --sys-prefix

# jupyter labextension install --no-build @ryantam626/jupyterlab_black  # Doesn't work yet...
jupyter labextension install --no-build @mflevine/jupyterlab_html
jupyter labextension install --no-build @jupyterlab/git
jupyter labextension install --no-build @jupyterlab/toc
jupyter labextension install --no-build @jupyterlab/latex
jupyter lab build
jupyter serverextension enable --sys-prefix --py jupyterlab
jupyter serverextension enable --sys-prefix --py jupyterlab_git
jupyter serverextension enable --sys-prefix --py jupyterlab_latex


# # Change shell to zsh and install oh-my-zsh
# chsh -s $(which zsh)
# curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh > ~/zsh_install.sh
# sed -i '/printf "\${GREEN}"/,/printf "\${NORMAL}"/d' ~/zsh_install.sh && sed -i '/^\s*env zsh$/d' ~/zsh_install.sh
# chmod u+x ~/zsh_install.sh
# sh -c ~/zsh_install.sh && rm ~/zsh_install.sh
# if [ -e ~/.zshrc.pre-oh-my-zsh ]; then
#     cat ~/.zshrc.pre-oh-my-zsh >> ~/.zshrc
# fi
# cat >> ~/.zshrc <<-EOL
# 	set -o magicequalsubst
# 	source ~/.iterm2_shell_integration.zsh
# 	if [ -f ~/.bash_aliases ]; then
# 	    . ~/.bash_aliases
# 	fi
# 	if [ -f ~/.profile ]; then
# 	   . ~/.profile
# 	fi
# 	export LC_CTYPE=en_US.UTF-8
# 	EOL
# sed -i "s/alias please='sudo'/# alias please='sudo'/" ~/.oh-my-zsh/lib/misc.zsh

# Copy over dotfiles from this repo
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cp ${DIR}/.gitconfig ~/
cp ${DIR}/.bash_aliases ~/
cp ${DIR}/.tmux.conf ~/
cp ${DIR}/.emacs ~/.emacs
rsync -az ${DIR}/.ssh ~/

# # Append to zshenv
# sudo mkdir -p /etc/zsh/
cat << 'RCFILE' | sudo tee -a /etc/profile
export IP_ADDRESS="$(head -1 /etc/hosts | grep -o 'ip[[:digit:]-]\{1,\}' | sed -e 's|ip-||' | sed -e 's|-|.|g')"
alias launch_jupyter="rm -f .nohup.out ; touch .nohup.out ; ( nohup jupyter lab --NotebookApp.token='' --no-browser --ip=\${IP_ADDRESS} >> .nohup.out 2>&1 & ) ; \
                     ( tail -Fn0 .nohup.out & ) | grep -om1 '[[:space:]]\{1,\}http.*'"
RCFILE

exit 0
